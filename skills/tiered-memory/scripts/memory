#!/usr/bin/env bash
# Tiered Memory CLI Wrapper - Auto-loads Turso credentials
# Usage: memory [command] [args...]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKSPACE_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"
CONFIG_FILE="$SCRIPT_DIR/../config.json"
CREDS_FILE="$WORKSPACE_ROOT/memory/encrypted/turso-credentials.json.enc"

# Load Turso credentials if not already set and cold operations need them
if [[ "${1:-}" == "cold" ]] || [[ "${1:-}" == "consolidate" ]] || [[ "${1:-}" == "sync-critical" ]]; then
    if [[ -z "${TURSO_URL:-}" ]] && [[ -f "$CREDS_FILE" ]]; then
        # Decrypt credentials
        if command -v "$WORKSPACE_ROOT/memory/decrypt.sh" &> /dev/null; then
            CREDS_JSON=$("$WORKSPACE_ROOT/memory/decrypt.sh" turso-credentials.json 2>/dev/null || echo "{}")
            export TURSO_URL=$(echo "$CREDS_JSON" | python3 -c 'import json,sys; print(json.load(sys.stdin).get("database_url", ""))' 2>/dev/null || echo "")
            export TURSO_TOKEN=$(echo "$CREDS_JSON" | python3 -c 'import json,sys; print(json.load(sys.stdin).get("auth_token", ""))' 2>/dev/null || echo "")
        fi
    fi
    
    # Auto-append Turso args if not already present
    if [[ -n "${TURSO_URL:-}" ]] && [[ ! " $* " =~ " --db-url " ]]; then
        set -- "$@" "--db-url" "$TURSO_URL" "--auth-token" "$TURSO_TOKEN"
    fi
fi

# Execute memory_cli.py with all arguments
exec python3 "$SCRIPT_DIR/memory_cli.py" "$@"
